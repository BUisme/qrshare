<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Heart Reply Animation ‚Äì ‡πÑ‡∏î‡πâ / ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</title>
  <style>
    :root{
      --bg:#0b0b12; --fg:#fff; --muted:#b7b7c6; --yes:#ff2a55; --no:#9aa0a6;
      --accent:#ff6ea6; --panel:rgba(255,255,255,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(1000px 700px at 50% 20%,#1a1a2b 0%,#0b0b12 60%);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .app{min-height:100%;display:grid;place-items:center;padding:16px}
    .card{width:min(720px,100%);border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);backdrop-filter:blur(8px);border-radius:24px;box-shadow:0 20px 60px rgba(0,0,0,.45);overflow:hidden}

    .head{padding:18px 20px;display:flex;justify-content:space-between;align-items:center}
    .head .title{font-weight:700}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);}

    .stage{position:relative;display:grid;place-items:center;padding:28px 18px}
    .names{position:absolute;inset:auto 0 16px 0;text-align:center;color:#fff;text-shadow:0 2px 14px rgba(255,42,85,.35)}
    .names .a,.names .b{font-weight:800}
    .names .amp{opacity:.9;margin:0 10px}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 18px}
    .row{display:flex;flex-wrap:wrap;gap:12px;margin:12px 18px}
    .inputs input{width:100%;padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:var(--panel);color:#fff;outline:none}
    .inputs input::placeholder{color:#c9c9d6}

    .actions{display:flex;gap:10px;justify-content:center;padding:8px 18px 22px;flex-wrap:wrap}
    .btn{cursor:pointer;user-select:none;padding:12px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:var(--panel);color:#fff;display:inline-flex;align-items:center;gap:10px;transition:.2s}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(135deg,#ff2a55,#ff6ea6);border-color:transparent;box-shadow:0 12px 28px rgba(255,42,85,.35)}

    .reply{display:flex;gap:10px;justify-content:center;padding:0 18px 22px}
    .reply .yes{background:linear-gradient(135deg,#ff2a55,#ff6ea6)}
    .reply .no{background:var(--panel)}

    /* Heart base */
    .heart-wrap{position:relative;width:min(420px,78vw);aspect-ratio:1/1;}
    svg{display:block;width:100%;height:100%}

    /* states */
    .full .heart-shape{fill:var(--yes);stroke:rgba(255,255,255,.6)}
    .full .heart-shape{animation:pulse 900ms ease forwards}
    @keyframes pulse{0%{transform:scale(.9)}40%{transform:scale(1.06)}100%{transform:scale(1)}}

    .broken .heart-shape{opacity:0}
    .broken .break-wrap{opacity:1}
    .break-wrap{position:absolute;inset:0;opacity:0;}
    .piece{position:absolute;width:50%;height:100%;}
    .left{left:0;}
    .right{right:0;}
    .piece svg{position:absolute;inset:0}

    .broken .left{animation:fallL 1200ms ease forwards}
    .broken .right{animation:fallR 1200ms ease forwards}
    @keyframes fallL{0%{transform:translate(0,0) rotate(0);opacity:1} 60%{transform:translate(-18px,16px) rotate(-12deg);}100%{transform:translate(-36px,120px) rotate(-22deg);opacity:.2}}
    @keyframes fallR{0%{transform:translate(0,0) rotate(0);opacity:1} 60%{transform:translate(18px,16px) rotate(12deg);}100%{transform:translate(36px,120px) rotate(22deg);opacity:.2}}

    .hint{font-size:12px;color:var(--muted);text-align:center;padding:10px 16px 18px}

    /* confetti */
    .confetti{pointer-events:none;position:absolute;inset:0;overflow:hidden}
    .piece-dot{position:absolute;width:8px;height:8px;border-radius:2px;background:var(--accent);opacity:0;animation:conf 1000ms ease-out forwards}
    @keyframes conf{0%{opacity:0;transform:translate(var(--x),-10px) rotate(0)}10%{opacity:1}100%{opacity:0;transform:translate(var(--x), calc(100% + 20px)) rotate(260deg)}}

    .note{font-size:13px;color:#e7e7f1;text-align:center;margin:0 18px 18px}
    code{background:#0002;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="app">
    <div class="card" id="card">
      <div class="head">
        <div class="title">Heart Reply Animation</div>
        <div class="badge" id="modeBadge">‡πÇ‡∏´‡∏°‡∏î: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå</div>
      </div>

      <div class="stage" id="stage">
        <div class="heart-wrap" id="heartBox">
          <!-- Whole heart (default) -->
          <svg viewBox="0 0 200 200" class="heart-shape" style="filter:drop-shadow(0 10px 30px rgba(255,42,85,.35))" fill="transparent" stroke="#ffd0dd" stroke-width="3">
            <path d="M100 180 C 40 130, 10 100, 10 65 a 40 40 0 0 1 70 -25 L100 52 l20 -12 a 40 40 0 0 1 70 25 c0 35 -30 65 -90 115z"/>
          </svg>

          <!-- Broken heart pieces -->
          <div class="break-wrap" aria-hidden="true">
            <div class="piece left">
              <svg viewBox="0 0 200 200" fill="#ff2a55" stroke="#ffc1d1" stroke-width="2">
                <path d="M100 180 C 40 130, 10 100, 10 65 a 40 40 0 0 1 70 -25 L100 52 l0 60 z"/>
              </svg>
            </div>
            <div class="piece right">
              <svg viewBox="0 0 200 200" fill="#ff2a55" stroke="#ffc1d1" stroke-width="2">
                <path d="M100 112 l20 -72 a 40 40 0 0 1 70 25 c0 35 -30 65 -90 115z"/>
              </svg>
            </div>
          </div>
        </div>
        <div class="names">
          <div><span class="a" id="nameA">‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1</span><span class="amp"> ‚ù§ </span><span class="b" id="nameB">‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2</span></div>
        </div>
        <div class="confetti" id="confetti"></div>
      </div>

      <!-- Creator mode: fill names & generate share link -->
      <div class="grid inputs" id="creatorInputs">
        <input id="inpA" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1" />
        <input id="inpB" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2" />
      </div>
      <div class="actions" id="creatorActions">
        <button class="btn primary" id="genLinkBtn">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2</button>
        <button class="btn" id="shareLinkBtn">‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
      </div>

      <!-- Receiver mode: reply yes/no and copy response back -->
      <div class="reply" id="reply" style="display:none">
        <button class="btn yes" id="yesBtn">‡πÑ‡∏î‡πâ üíñ</button>
        <button class="btn no" id="noBtn">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ üíî</button>
      </div>

      <div class="row" id="responseActions" style="display:none;justify-content:center">
        <button class="btn" id="copyRespBtn">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö</button>
        <button class="btn" id="shareRespBtn">‡πÅ‡∏ä‡∏£‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
        <!-- download buttons will be injected here -->
      </div>

      <p class="note" id="note"></p>

      <div class="hint">‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå: ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ ‚Üí ‡∏Å‡∏î "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2"<br>‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏≠‡∏ö: ‡∏Å‡∏î "‡πÑ‡∏î‡πâ" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ" ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ</div>
    </div>
  </div>

  <script>
    // ===== Elements =====
    const nameA = document.getElementById('nameA');
    const nameB = document.getElementById('nameB');
    const inpA = document.getElementById('inpA');
    const inpB = document.getElementById('inpB');

    const genLinkBtn = document.getElementById('genLinkBtn');
    const shareLinkBtn = document.getElementById('shareLinkBtn');

    const yesBtn = document.getElementById('yesBtn');
    const noBtn = document.getElementById('noBtn');
    const reply = document.getElementById('reply');

    const responseActions = document.getElementById('responseActions');
    const copyRespBtn = document.getElementById('copyRespBtn');
    const shareRespBtn = document.getElementById('shareRespBtn');

    const creatorInputs = document.getElementById('creatorInputs');
    const creatorActions = document.getElementById('creatorActions');

    const heartBox = document.getElementById('heartBox');
    const confetti = document.getElementById('confetti');
    const modeBadge = document.getElementById('modeBadge');
    const note = document.getElementById('note');

    // Download buttons (created lazily)
    const dlBtnPng = document.createElement('button');
    dlBtnPng.className='btn';
    dlBtnPng.id='downloadPngBtn';
    dlBtnPng.textContent='‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (PNG)';

    const dlBtnTxt = document.createElement('button');
    dlBtnTxt.className='btn';
    dlBtnTxt.id='downloadTxtBtn';
    dlBtnTxt.textContent='‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (TXT)';

    // ===== Audio (WebAudio) =====
    let audioCtx;
    function getCtx(){ return audioCtx || (audioCtx = new (window.AudioContext||window.webkitAudioContext)()); }
    function beep(f=880, t=0.18, type='sine', gain=0.03){
      const ctx=getCtx();
      const o=ctx.createOscillator();
      const g=ctx.createGain();
      o.type=type; o.frequency.setValueAtTime(f, ctx.currentTime);
      g.gain.value=gain; o.connect(g); g.connect(ctx.destination);
      o.start(); o.stop(ctx.currentTime+t);
    }
    function chord(freqs=[660,880,1100], t=0.22){ freqs.forEach((f,i)=>setTimeout(()=>beep(f, t, 'triangle', 0.03), i*20)); }
    function crack(){
      const ctx=getCtx();
      const buffer=ctx.createBuffer(1, ctx.sampleRate*0.2, ctx.sampleRate);
      const data=buffer.getChannelData(0);
      for(let i=0;i<data.length;i++){ data[i]=(Math.random()*2-1)*Math.pow(1-i/data.length,2); }
      const src=ctx.createBufferSource(); src.buffer=buffer;
      const g=ctx.createGain(); g.gain.value=0.08; src.connect(g); g.connect(ctx.destination);
      src.start();
      const o=ctx.createOscillator(); o.type='square'; o.frequency.setValueAtTime(220, ctx.currentTime);
      o.frequency.exponentialRampToValueAtTime(110, ctx.currentTime+0.25);
      const gg=ctx.createGain(); gg.gain.value=0.03; o.connect(gg); gg.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.25);
      setTimeout(()=>{g.gain.setTargetAtTime(0, ctx.currentTime, 0.05);},150);
    }

    // ===== Helpers =====
    const qs = new URLSearchParams(location.search);
    function dec(s){ try{return decodeURIComponent((s||'').replace(/\+/g,'%20'));}catch{return s||''} }
    function setNames(a,b){ nameA.textContent=a||'‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1'; nameB.textContent=b||'‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2'; }

    function buildURL(params){
      const u = new URL(location.href);
      ['a','b','mode','r'].forEach(k=>u.searchParams.delete(k));
      Object.entries(params).forEach(([k,v])=>{ if(v!=null) u.searchParams.set(k,v); });
      return u.toString();
    }

    async function copy(text){
      try{ await navigator.clipboard.writeText(text); return true; }catch{ return false; }
    }

    async function share(opts){
      try{ if(navigator.share){ await navigator.share(opts); return true; } }catch{}
      return false;
    }

    function celebrate(){
      const n = 50;
      for(let i=0;i<n;i++){
        const d = document.createElement('div');
        d.className='piece-dot';
        d.style.left = Math.random()*100 + '%';
        d.style.setProperty('--x', (Math.random()*100-50)+'px');
        d.style.background = `hsl(${Math.floor(Math.random()*360)}, 90%, 60%)`;
        d.style.animationDelay = (Math.random()*0.5)+'s';
        confetti.appendChild(d);
        setTimeout(()=>d.remove(), 1300);
      }
    }

    function toCreator(){
      modeBadge.textContent='‡πÇ‡∏´‡∏°‡∏î: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå';
      creatorInputs.style.display='grid';
      creatorActions.style.display='flex';
      reply.style.display='none';
      responseActions.style.display='none';
      note.textContent='';
      heartBox.classList.remove('full','broken');
      dlBtnPng.remove(); dlBtnTxt.remove();
    }

    function toReceiver(a,b){
      modeBadge.textContent='‡πÇ‡∏´‡∏°‡∏î: ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö';
      creatorInputs.style.display='none';
      creatorActions.style.display='none';
      reply.style.display='flex';
      responseActions.style.display='none';
      setNames(a,b);
      note.innerHTML=`‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <b>${a||'‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1'}</b> ‚ù§ <b>${b||'‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2'}</b> ‚Äî ‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡∏ï‡∏≠‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö`;
      heartBox.classList.remove('full','broken');
      dlBtnPng.remove(); dlBtnTxt.remove();
    }

    function showResult(a,b,r){
      modeBadge.textContent='‡πÇ‡∏´‡∏°‡∏î: ‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå';
      creatorInputs.style.display='none';
      creatorActions.style.display='none';
      reply.style.display='none';
      responseActions.style.display='none';
      setNames(a,b);
      heartBox.classList.remove('full','broken');
      if(r==='yes'){ heartBox.classList.add('full'); chord(); celebrate(); note.innerHTML=`‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: <b>${b}</b> ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ <b>‡πÑ‡∏î‡πâ</b> üíñ`; }
      else if(r==='no'){ heartBox.classList.add('broken'); crack(); note.innerHTML=`‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: <b>${b}</b> ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ <b>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</b> üíî`; }
      else { note.textContent='‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ'; }
      responseActions.after(dlBtnPng, dlBtnTxt);
      dlBtnPng.style.display='inline-flex';
      dlBtnTxt.style.display='inline-flex';
      dlBtnPng.onclick = ()=>downloadPNG(a,b,r||'view');
      dlBtnTxt.onclick = ()=>downloadTXT(a,b,r||'view');
    }

    // ===== Render to PNG (pure Canvas) =====
    function renderToCanvas(a,b,r, size=1200){
      const c = document.createElement('canvas');
      c.width=size; c.height=size; const ctx=c.getContext('2d');

      // bg gradient
      const g = ctx.createRadialGradient(size*0.5, size*0.2, size*0.1, size*0.5, size*0.5, size*0.7);
      g.addColorStop(0, '#1a1a2b'); g.addColorStop(1, '#0b0b12');
      ctx.fillStyle=g; ctx.fillRect(0,0,size,size);

      // names
      ctx.fillStyle='#ffffff';
      ctx.shadowColor='rgba(255,42,85,0.35)';
      ctx.shadowBlur=20;
      ctx.font=`700 ${Math.round(size*0.06)}px system-ui, Segoe UI, Arial`;
      ctx.textAlign='center';
      ctx.fillText(`${a} ‚ù§ ${b}`, size/2, size*0.87);
      ctx.shadowBlur=0;

      function drawHeartPath(scale=1){
        const w=size*0.6*scale; const x=(size-w)/2; const y=size*0.18;
        const h=w; const cx=x+w/2;
        ctx.beginPath();
        ctx.moveTo(cx, y+h*0.9);
        ctx.bezierCurveTo(x+w*0.2, y+h*0.65, x+w*0.05, y+h*0.45, x+w*0.05, y+h*0.25);
        ctx.bezierCurveTo(x+w*0.05, y+h*0.07, x+w*0.2, y, x+w*0.35, y);
        ctx.bezierCurveTo(x+w*0.5, y, x+w*0.58, y+h*0.08, cx, y+h*0.19);
        ctx.bezierCurveTo(x+w*0.82, y+h*0.08, x+w*0.9, y, x+w*0.95, y+h*0.25);
        ctx.bezierCurveTo(x+w*0.95, y+h*0.45, x+w*0.8, y+h*0.65, cx, y+h*0.9);
      }

      if(r==='yes'){
        drawHeartPath(1);
        const grad=ctx.createLinearGradient(0, size*0.2, 0, size*0.8);
        grad.addColorStop(0,'#ff6ea6'); grad.addColorStop(1,'#ff2a55');
        ctx.fillStyle=grad; ctx.fill();
        ctx.lineWidth=6; ctx.strokeStyle='rgba(255,255,255,0.6)'; ctx.stroke();
        for(let i=0;i<80;i++){
          ctx.fillStyle=`hsl(${Math.floor(Math.random()*360)},90%,60%)`;
          const px=Math.random()*size; const py=Math.random()*size*0.9; const w=6+Math.random()*8; const h=6+Math.random()*8;
          ctx.save(); ctx.translate(px,py); ctx.rotate(Math.random()*Math.PI); ctx.fillRect(-w/2,-h/2,w,h); ctx.restore();
        }
        ctx.fillStyle='#eaeaf6';
        ctx.font=`600 ${Math.round(size*0.045)}px system-ui, Segoe UI, Arial`;
        ctx.fillText(`${b} ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ ‡πÑ‡∏î‡πâ üíñ`, size/2, size*0.95);
      } else if(r==='no'){
        const off= size*0.02;
        ctx.save(); ctx.translate(-off, off);
        drawHeartPath(1);
        const gradL=ctx.createLinearGradient(0, size*0.2, 0, size*0.8);
        gradL.addColorStop(0,'#ff6ea6'); gradL.addColorStop(1,'#ff2a55');
        ctx.clip(); ctx.fillStyle=gradL; ctx.fillRect(0,0,size,size); ctx.restore();
        ctx.save(); ctx.globalCompositeOperation='destination-out';
        ctx.beginPath();
        const x=size*0.5; const y=size*0.28; const z=size*0.75;
        ctx.moveTo(x, y); ctx.lineTo(x-12, y+40); ctx.lineTo(x+10, y+80); ctx.lineTo(x-8, y+120); ctx.lineTo(x+12, z);
        ctx.lineWidth=10; ctx.stroke(); ctx.restore();
        ctx.lineWidth=6; ctx.strokeStyle='rgba(255,255,255,0.6)'; drawHeartPath(1); ctx.stroke();
        ctx.fillStyle='#eaeaf6';
        ctx.font=`600 ${Math.round(size*0.045)}px system-ui, Segoe UI, Arial`;
        ctx.fillText(`${b} ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ üíî`, size/2, size*0.95);
      } else {
        drawHeartPath(1); ctx.strokeStyle='#ffd0dd'; ctx.lineWidth=4; ctx.stroke();
      }
      return c;
    }

    function downloadBlob(filename, blob){
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
    }

    function filenameSafe(s){ return (s||'').replace(/\s+/g,'_').replace(/[^\w\-‡∏Å-‡πô]/g,'').slice(0,40)||'result'; }

    async function downloadPNG(a,b,r){
      const canvas = renderToCanvas(a,b,r, 1200);
      canvas.toBlob(blob=>{ if(blob){ downloadBlob(`${filenameSafe(a)}_‚ù§_${filenameSafe(b)}_${r||'view'}.png`, blob); } }, 'image/png');
    }

    async function downloadTXT(a,b,r){
      const text = `‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1: ${a}\n‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2: ${b}\n‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö: ${r==='yes'?'‡πÑ‡∏î‡πâ üíñ': r==='no'?'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ üíî':'(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)'}\n‡∏•‡∏¥‡∏á‡∏Å‡πå: ${location.href}`;
      const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
      downloadBlob(`${filenameSafe(a)}_‚ù§_${filenameSafe(b)}_${r||'view'}.txt`, blob);
    }

    // ===== Events =====
    document.getElementById('inpA')?.addEventListener('input', e=> setNames(e.target.value, inpB.value));
    document.getElementById('inpB')?.addEventListener('input', e=> setNames(inpA.value, e.target.value));

    genLinkBtn?.addEventListener('click', async ()=>{
      const a = inpA.value.trim(); const b = inpB.value.trim(); setNames(a,b);
      const url = buildURL({ a: a||'‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1', b: b||'‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2', mode:'ask' });
      const ok = await copy(url);
      note.innerHTML = (ok? '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2 ‡πÅ‡∏•‡πâ‡∏ß ‚úî' : '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡∏Å‡∏î ‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå') + ` <br><code>${url}</code>`;
    });

    shareLinkBtn?.addEventListener('click', async ()=>{
      const a = inpA.value.trim(); const b = inpB.value.trim(); setNames(a,b);
      const url = buildURL({ a: a||'‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1', b: b||'‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2', mode:'ask' });
      const ok = await share({ title:'‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°?', text:`${a||'‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1'} ‚ù§ ${b||'‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2'}`, url });
      if(!ok){ await copy(url); }
      note.innerHTML = '‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 2 ‡πÅ‡∏•‡πâ‡∏ß (‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)';
    });

    yesBtn?.addEventListener('click', async ()=>{
      heartBox.classList.remove('broken');
      heartBox.classList.add('full');
      chord(); celebrate();
      const a = nameA.textContent; const b = nameB.textContent;
      const resp = buildURL({ a, b, mode:'reply', r:'yes' });
      responseActions.style.display='flex';
      if(!dlBtnPng.isConnected){ responseActions.append(dlBtnPng, dlBtnTxt); }
      dlBtnPng.onclick = ()=>downloadPNG(a,b,'yes');
      dlBtnTxt.onclick = ()=>downloadTXT(a,b,'yes');
      copyRespBtn.onclick = async ()=>{ await copy(resp); note.innerHTML = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úî<br><code>'+resp+'</code>'; };
      shareRespBtn.onclick = async ()=>{ const ok = await share({ title:'‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö', text:`${b} ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ ‡πÑ‡∏î‡πâ üíñ`, url: resp }); if(!ok){ await copy(resp); } };
      note.innerHTML = '‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå';
    });

    noBtn?.addEventListener('click', async ()=>{
      heartBox.classList.remove('full');
      heartBox.classList.add('broken');
      crack();
      const a = nameA.textContent; const b = nameB.textContent;
      const resp = buildURL({ a, b, mode:'reply', r:'no' });
      responseActions.style.display='flex';
      if(!dlBtnPng.isConnected){ responseActions.append(dlBtnPng, dlBtnTxt); }
      dlBtnPng.onclick = ()=>downloadPNG(a,b,'no');
      dlBtnTxt.onclick = ()=>downloadTXT(a,b,'no');
      copyRespBtn.onclick = async ()=>{ await copy(resp); note.innerHTML = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úî<br><code>'+resp+'</code>'; };
      shareRespBtn.onclick = async ()=>{ const ok = await share({ title:'‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö', text:`${b} ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ üíî`, url: resp }); if(!ok){ await copy(resp); } };
      note.innerHTML = '‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå';
    });

    // ===== Router (detect mode from URL) =====
    (function init(){
      const a = dec(qs.get('a')); const b = dec(qs.get('b'));
      const mode = qs.get('mode');
      const r = qs.get('r');
      if(a || b){ setNames(a,b); if(inpA) inpA.value=a||''; if(inpB) inpB.value=b||''; }
      if(mode==='ask'){ toReceiver(a,b); }
      else if(mode==='reply'){ showResult(a,b,r); }
      else { toCreator(); }
    })();
  </script>
</body>
</html>
